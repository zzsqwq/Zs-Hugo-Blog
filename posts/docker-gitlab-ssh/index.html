<!doctype html><html lang=en><head><title>Docker-Gitlab 与主机共用 ssh 的 22 端口 · Zs's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="zzsqwq"><meta name=description content="背景 Link to heading 在使用 Docker 搭建 Gitlab/Gitee 会导致无法与主机端共用 22 端口，这导致 ssh 连接的时候会使用形如 ssh://git@git.xxxx.cn:4022/zs/zsblog.git 的 ssh 链接，而不是像官方 Gitlab 那种非常干净的 git@git.xxxx.cn/zs/zsblog.git 链接。这对于我这种强迫症而言非常的难受啊，但因为主机的 22 端口已经被占用了，无法共用，所以需要考虑两者共享端口的问题。
虽说是两者共用，但其实还是使用类似于端口转发的特点，简单说就是在主机设置 git 用户，然后通过一个脚本将 git 用户的所有 ssh 流量转发到 Gitlab 容器中，从而完成对应的事情。
关于 Gitee 的设置，Gitee 官方的 Docker 部署教程1已经说的很清楚了，按照该步骤执行完全没问题。
而关于 Gitlab 貌似没有比较详尽的教程，搜索后发现了一个 Issue2 以及一篇博文3，后者讲的比较清楚，但是经过实践后发现存在一定问题，因此决定将可行的方案记录下来。
具体步骤 Link to heading 一、初始设置 Link to heading 在开始之前，docker-compose.yml 中设置比较关键的几个配置如下：
gitlab-web: image: 'gitlab/gitlab-ce:latest' container_name: 'gitlab' restart: always environment: GITLAB_OMNIBUS_CONFIG: | gitlab_rails['gitlab_shell_ssh_port'] = 4022 ports: - '3090:80' - '4022:22' - '6060:6060' volumes: - '/srv/gitlab/config:/etc/gitlab' - '/srv/gitlab/logs:/var/log/gitlab' - '/srv/gitlab/data:/var/opt/gitlab' - ."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker-Gitlab 与主机共用 ssh 的 22 端口"><meta name=twitter:description content="背景 Link to heading 在使用 Docker 搭建 Gitlab/Gitee 会导致无法与主机端共用 22 端口，这导致 ssh 连接的时候会使用形如 ssh://git@git.xxxx.cn:4022/zs/zsblog.git 的 ssh 链接，而不是像官方 Gitlab 那种非常干净的 git@git.xxxx.cn/zs/zsblog.git 链接。这对于我这种强迫症而言非常的难受啊，但因为主机的 22 端口已经被占用了，无法共用，所以需要考虑两者共享端口的问题。
虽说是两者共用，但其实还是使用类似于端口转发的特点，简单说就是在主机设置 git 用户，然后通过一个脚本将 git 用户的所有 ssh 流量转发到 Gitlab 容器中，从而完成对应的事情。
关于 Gitee 的设置，Gitee 官方的 Docker 部署教程1已经说的很清楚了，按照该步骤执行完全没问题。
而关于 Gitlab 貌似没有比较详尽的教程，搜索后发现了一个 Issue2 以及一篇博文3，后者讲的比较清楚，但是经过实践后发现存在一定问题，因此决定将可行的方案记录下来。
具体步骤 Link to heading 一、初始设置 Link to heading 在开始之前，docker-compose.yml 中设置比较关键的几个配置如下：
gitlab-web: image: 'gitlab/gitlab-ce:latest' container_name: 'gitlab' restart: always environment: GITLAB_OMNIBUS_CONFIG: | gitlab_rails['gitlab_shell_ssh_port'] = 4022 ports: - '3090:80' - '4022:22' - '6060:6060' volumes: - '/srv/gitlab/config:/etc/gitlab' - '/srv/gitlab/logs:/var/log/gitlab' - '/srv/gitlab/data:/var/opt/gitlab' - ."><meta property="og:title" content="Docker-Gitlab 与主机共用 ssh 的 22 端口"><meta property="og:description" content="背景 Link to heading 在使用 Docker 搭建 Gitlab/Gitee 会导致无法与主机端共用 22 端口，这导致 ssh 连接的时候会使用形如 ssh://git@git.xxxx.cn:4022/zs/zsblog.git 的 ssh 链接，而不是像官方 Gitlab 那种非常干净的 git@git.xxxx.cn/zs/zsblog.git 链接。这对于我这种强迫症而言非常的难受啊，但因为主机的 22 端口已经被占用了，无法共用，所以需要考虑两者共享端口的问题。
虽说是两者共用，但其实还是使用类似于端口转发的特点，简单说就是在主机设置 git 用户，然后通过一个脚本将 git 用户的所有 ssh 流量转发到 Gitlab 容器中，从而完成对应的事情。
关于 Gitee 的设置，Gitee 官方的 Docker 部署教程1已经说的很清楚了，按照该步骤执行完全没问题。
而关于 Gitlab 貌似没有比较详尽的教程，搜索后发现了一个 Issue2 以及一篇博文3，后者讲的比较清楚，但是经过实践后发现存在一定问题，因此决定将可行的方案记录下来。
具体步骤 Link to heading 一、初始设置 Link to heading 在开始之前，docker-compose.yml 中设置比较关键的几个配置如下：
gitlab-web: image: 'gitlab/gitlab-ce:latest' container_name: 'gitlab' restart: always environment: GITLAB_OMNIBUS_CONFIG: | gitlab_rails['gitlab_shell_ssh_port'] = 4022 ports: - '3090:80' - '4022:22' - '6060:6060' volumes: - '/srv/gitlab/config:/etc/gitlab' - '/srv/gitlab/logs:/var/log/gitlab' - '/srv/gitlab/data:/var/opt/gitlab' - ."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.zzsqwq.cn/posts/docker-gitlab-ssh/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-24T13:46:00+00:00"><meta property="article:modified_time" content="2022-04-24T13:46:00+00:00"><link rel=canonical href=https://blog.zzsqwq.cn/posts/docker-gitlab-ssh/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.f765a0ff3020452ae08fb0d0500e0b84e5baedb574f7c611e8b2b2cea0323eee.css integrity="sha256-92Wg/zAgRSrgj7DQUA4LhOW67bV098YR6LKyzqAyPu4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Zs's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=/friends/>Friends</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact Me</a></li><li class=navigation-item><a class=navigation-link href=https://zzsqwq.cn/>Homepage</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://blog.zzsqwq.cn/posts/docker-gitlab-ssh/>Docker-Gitlab 与主机共用 ssh 的 22 端口</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-04-24T13:46:00Z>April 24, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
8-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/>瞎折腾</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/docker/>Docker</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/gitlab/>Gitlab</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/ssh/>ssh</a></span></div></div></header><div class=post-content><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>在使用 Docker 搭建 Gitlab/Gitee 会导致无法与主机端共用 22 端口，这导致 ssh 连接的时候会使用形如 <code>ssh://git@git.xxxx.cn:4022/zs/zsblog.git</code> 的 ssh 链接，而不是像官方 Gitlab 那种非常干净的 <code>git@git.xxxx.cn/zs/zsblog.git</code> 链接。这对于我这种强迫症而言非常的难受啊，但因为主机的 22 端口已经被占用了，无法共用，所以需要考虑两者共享端口的问题。</p><p>虽说是两者共用，但其实还是使用类似于端口转发的特点，简单说就是在主机设置 <code>git</code> 用户，然后通过一个脚本将 <code>git</code> 用户的所有 ssh 流量转发到 Gitlab 容器中，从而完成对应的事情。</p><p>关于 Gitee 的设置，Gitee 官方的 Docker 部署教程<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>已经说的很清楚了，按照该步骤执行完全没问题。</p><p>而关于 Gitlab 貌似没有比较详尽的教程，搜索后发现了一个 Issue<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> 以及一篇博文<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>，后者讲的比较清楚，但是经过实践后发现存在一定问题，因此决定将可行的方案记录下来。</p><h2 id=具体步骤>具体步骤
<a class=heading-link href=#%e5%85%b7%e4%bd%93%e6%ad%a5%e9%aa%a4><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><h3 id=一初始设置>一、初始设置
<a class=heading-link href=#%e4%b8%80%e5%88%9d%e5%a7%8b%e8%ae%be%e7%bd%ae><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>在开始之前，<code>docker-compose.yml</code> 中设置比较关键的几个配置如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gitlab-web:
</span></span><span style=display:flex><span>	image: <span style=color:#e6db74>&#39;gitlab/gitlab-ce:latest&#39;</span>
</span></span><span style=display:flex><span>	container_name: <span style=color:#e6db74>&#39;gitlab&#39;</span>
</span></span><span style=display:flex><span>	restart: always
</span></span><span style=display:flex><span>	environment:
</span></span><span style=display:flex><span>		GITLAB_OMNIBUS_CONFIG: |
</span></span><span style=display:flex><span>			gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;gitlab_shell_ssh_port&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4022</span>
</span></span><span style=display:flex><span>	ports:
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;3090:80&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;4022:22&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;6060:6060&#39;</span>
</span></span><span style=display:flex><span>	volumes:
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/srv/gitlab/config:/etc/gitlab&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/srv/gitlab/logs:/var/log/gitlab&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/srv/gitlab/data:/var/opt/gitlab&#39;</span>
</span></span><span style=display:flex><span>		- .... <span style=color:#75715e>#一些其他的配置</span>
</span></span></code></pre></div><p>如上设置基本可以确保 Gitlab 形如 <code>ssh://git@git.xxxx.cn:4022/zs/zsblog.git</code> 的链接可以使用。</p><h3 id=二在-host-宿主机创建与-gitlab-相同的-git-user>二、在 Host 宿主机创建与 Gitlab 相同的 git user
<a class=heading-link href=#%e4%ba%8c%e5%9c%a8-host-%e5%ae%bf%e4%b8%bb%e6%9c%ba%e5%88%9b%e5%bb%ba%e4%b8%8e-gitlab-%e7%9b%b8%e5%90%8c%e7%9a%84-git-user><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>为了确保后续一些麻烦的权限问题，我们需要在宿主机也创建一个 <code>git</code> 用户。</p><p>首先我们要检查 Gitlab 容器中 <code>git</code> 用户的 UID 以及 GID，如果不出意外的话，两者都已被<a href=https://gitlab.com/gitlab-org/omnibus-gitlab/blob/d4f3f5d57b16dbf1e1a59f9a5f5cc041ddacf05a/docker/assets/setup class=external-link target=_blank rel=noopener>硬编码为 998</a> 。不过为了以防万一，我们可以通过下述指令进一步确认：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ docker exec -it gitlab cat /etc/passwd | awk -F<span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#e6db74>&#39;{if($1==&#34;git&#34;) printf(&#34;uid: %s; gid: %s\n&#34;), $3, $4}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 不出意外结果如下，证明 git 账户的 UID 与 GID 都为 998.</span>
</span></span><span style=display:flex><span>uid: 998; gid: <span style=color:#ae81ff>998</span>
</span></span></code></pre></div><p>这条指令会给出我们对应的 UID 以及 GID。</p><p>接下来我们需要在宿主机中也创建 <code>git</code> 用户，确保 UID 及 GID 都与 Gitlab 容器内的一致。大家可以通过如下指令查看是否已有 <code>git</code> 用户，以及其 UID 与 GID。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ cat /etc/passwd | awk -F<span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#e6db74>&#39;{if($1==&#34;git&#34;) printf(&#34;uid: %s; gid: %s\n&#34;), $3, $4}&#39;</span>
</span></span></code></pre></div><ul><li>如果没有任何结果，说明没有 <code>git</code> 用户</li><li>如果有结果，并且 UID 与 GID 不为 998，说明需要重新该一下对应的 UID 与 GID，大家可以自行搜索解决方案。</li><li>我们还需要查看 <code>/etc/passwd</code> 与 <code>/etc/group</code> 两个文件确保 998 没有被使用，如果有使用也需要做对应改变。</li></ul><p>如果没有 <code>git</code> 用户，则使用下面指令创建并指定家目录为 <code>/home/git</code> （在 root 用户下）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ groupadd -g <span style=color:#ae81ff>998</span> git
</span></span><span style=display:flex><span>❯ useradd -m -u <span style=color:#ae81ff>998</span> -g git -s /bin/sh -d /home/git git
</span></span></code></pre></div><p>如果已有，则确保其 UID 与 GID 和 Gitlab 容器中 <code>git</code> 用户相同，并确保有家目录 <code>/home/git</code>。</p><h3 id=三复制-gitlab-密钥文件>三、复制 Gitlab 密钥文件
<a class=heading-link href=#%e4%b8%89%e5%a4%8d%e5%88%b6-gitlab-%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Gitlab 的密钥文件目前存放在容器的 <code>/var/opt/gitlab/.ssh</code> 中，然后根据你在 <code>docker-compose.yml</code> 配置的映射位置看，好比我配置的映射是 <code>/srv/gitlab/data:/var/opt/gitlab</code>，你就可以直接在 <code>/srv/gitlab/data/.ssh</code> 目录下找到对应的密钥文件。</p><p>然后首先在 <code>root</code> 用户权限下执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ cp -r /srv/gitlab/data/.ssh /home/git/.ssh
</span></span></code></pre></div><p>将对应的文件夹复制到 <code>git</code> 用户家目录下，然后执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ chown -R git:git /home/git/.ssh
</span></span></code></pre></div><p>将所有的文件的权限及组权限都更改为 <code>git</code> 用户</p><p>现在 <code>git</code> 用户的 <code>.ssh</code> 目录结构应该如下，也要确保 <code>.ssh</code> 文件权限为 <code>700</code>，<code>authorized_keys</code> 权限为 600<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ ls -la
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>72</span>
</span></span><span style=display:flex><span>drwx------ <span style=color:#ae81ff>2</span> git git  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 15:40 .
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>5</span> git git  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 02:00 ..
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> git git <span style=color:#ae81ff>50122</span> Apr <span style=color:#ae81ff>24</span> 02:00 authorized_keys
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> git git     <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>24</span> 01:57 authorized_keys.lock
</span></span><span style=display:flex><span>-rw------- <span style=color:#ae81ff>1</span> git git  <span style=color:#ae81ff>1679</span> Apr <span style=color:#ae81ff>24</span> 01:48 id_rsa
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> git git   <span style=color:#ae81ff>390</span> Apr <span style=color:#ae81ff>24</span> 01:48 id_rsa.pub
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> git git   <span style=color:#ae81ff>222</span> Apr <span style=color:#ae81ff>24</span> 02:00 known_hosts
</span></span></code></pre></div><h3 id=四生成密钥文件>四、生成密钥文件
<a class=heading-link href=#%e5%9b%9b%e7%94%9f%e6%88%90%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>切换到 <code>git</code> 用户并生成密钥对</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>❯ su - git
</span></span><span style=display:flex><span>❯ ssh-keygen <span style=color:#75715e>#然后一路回车</span>
</span></span></code></pre></div><p>然后将公钥加入 <code>authorized_keys</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>❯ cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys 
</span></span></code></pre></div><h3 id=五创建脚本文件>五、创建脚本文件
<a class=heading-link href=#%e4%ba%94%e5%88%9b%e5%bb%ba%e8%84%9a%e6%9c%ac%e6%96%87%e4%bb%b6><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>我们不妨看一下现在的 <code>authorized_keys</code> 文件，里面应该有形如下面的内容一些行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>command<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell key-105&#34;</span>,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-ed25519 xxxxxxxx
</span></span></code></pre></div><p>这里说明我们提交时会执行一个 <code>/opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell</code> 脚本，这里本应该执行的是容器内的脚本，但是我们现在把它放在了容器外，因此我们需要设置一个脚本将请求转发进去，因此选择在本机的 <code>/opt/gitlab/embedded/service/gitlab-shell/bin</code> 目录下创建一个名为 <code>gitlab-shell</code> 的脚本，命令如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建文件夹</span>
</span></span><span style=display:flex><span>❯ sudo mkdir -p /opt/gitlab/embedded/service/gitlab-shell/bin
</span></span><span style=display:flex><span><span style=color:#75715e># 进入文件夹</span>
</span></span><span style=display:flex><span>❯ cd /opt/gitlab/embedded/service/gitlab-shell/bin
</span></span><span style=display:flex><span><span style=color:#75715e># 创建文件</span>
</span></span><span style=display:flex><span>❯ sudo vim gitlab-shell
</span></span></code></pre></div><p>文件内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>ssh -i /home/git/.ssh/id_rsa -p <span style=color:#ae81ff>4022</span> -o StrictHostKeyChecking<span style=color:#f92672>=</span>no git@127.0.0.1 <span style=color:#e6db74>&#34;SSH_ORIGINAL_COMMAND=\&#34;</span>$SSH_ORIGINAL_COMMAND<span style=color:#e6db74>\&#34; </span>$0<span style=color:#e6db74> </span>$@<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>需要注意的是，这里的 <code>4022</code> 是指在 <code>docker-compose.yml</code> 文件映射的 <code>4022:22</code> 端口，如果你是 <code>xxx:22</code> ，则需要在这里填写 <code>xxx</code>，对应起来。内</p><p>然后不要忘记添加执行权限</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>❯ sudo chmod +x /opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell
</span></span></code></pre></div><h3 id=六挂载额外的文件到-gitlab-容器>六、挂载额外的文件到 Gitlab 容器
<a class=heading-link href=#%e5%85%ad%e6%8c%82%e8%bd%bd%e9%a2%9d%e5%a4%96%e7%9a%84%e6%96%87%e4%bb%b6%e5%88%b0-gitlab-%e5%ae%b9%e5%99%a8><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>修改我们的 <code>docker-compose.yml</code> ，注释掉 <code>gitlab_rails['gitlab_shell_ssh_port'] = 4022</code> 以及添加 <code>'/home/git/.ssh/:/var/opt/gitlab/.ssh'</code> ，将 <code>git</code> 用户的 <code>.ssh</code> 目录挂载到容器内。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gitlab-web:
</span></span><span style=display:flex><span>	image: <span style=color:#e6db74>&#39;gitlab/gitlab-ce:latest&#39;</span>
</span></span><span style=display:flex><span>	container_name: <span style=color:#e6db74>&#39;gitlab&#39;</span>
</span></span><span style=display:flex><span>	restart: always
</span></span><span style=display:flex><span>	environment:
</span></span><span style=display:flex><span>		GITLAB_OMNIBUS_CONFIG: |
</span></span><span style=display:flex><span>				....
</span></span><span style=display:flex><span>	ports:
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;3090:80&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;4022:22&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;6060:6060&#39;</span>
</span></span><span style=display:flex><span>	volumes:
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/srv/gitlab/config:/etc/gitlab&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/srv/gitlab/logs:/var/log/gitlab&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/srv/gitlab/data:/var/opt/gitlab&#39;</span>
</span></span><span style=display:flex><span>		- <span style=color:#e6db74>&#39;/home/git/.ssh/:/var/opt/gitlab/.ssh&#39;</span>
</span></span><span style=display:flex><span>		- .... <span style=color:#75715e>#一些其他的配置</span>
</span></span></code></pre></div><p>最后，重启容器即可生效。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>❯ docker-compose up -d
</span></span></code></pre></div><h2 id=简单的原理说明>简单的原理说明
<a class=heading-link href=#%e7%ae%80%e5%8d%95%e7%9a%84%e5%8e%9f%e7%90%86%e8%af%b4%e6%98%8e><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>使用的原理就是将主机 <code>git</code> 用户的所有 ssh 流量都转发到容器内部。</p><p>转发使用的是宿主机中的<code>/opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell</code> 脚本，而因为已经将主机 <code>git</code> 用户 <code>id_rsa.pub</code> 添加到了 <code>authorized_keys</code> 中，因此可以直接免密转发内容到容器内部。</p><p>随后，容器内的 <code>gitlab-shell</code> 脚本对请求进行处理，完成 ssh 请求。</p><p>这里很巧妙的使用了同一个位置的脚本，这也是需要将 <code>git</code> 用户的 <code>.ssh</code> 目录挂载到 Gitlab 内部的原因，但是每个脚本却作用不同，十分的巧妙。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.gitea.io/zh-cn/install-with-docker/ class=external-link target=_blank rel=noopener>使用 Docker 安装</a> ↩&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://github.com/sameersbn/docker-gitlab/issues/1517 class=external-link target=_blank rel=noopener>Sharing SSH port between host and the container</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://blog.xiaket.org/2017/exposing.ssh.port.in.dockerized.gitlab-ce.html class=external-link target=_blank rel=noopener>Exposing ssh port in dockerized gitlab-ce</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://blog.csdn.net/kangkanglou/article/details/90760529 class=external-link target=_blank rel=noopener>公钥添加到authorized_keys到文件中之后仍无法免密登陆</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"preferred_color_scheme";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","zzsqwq/hugo-blog-comment"),s.setAttribute("data-repo-id","R_kgDOGgU1qQ"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGgU1qc4CSX1m"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","top"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"preferred_color_scheme";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","zzsqwq/hugo-blog-comment"),s.setAttribute("data-repo-id","R_kgDOGgU1qQ"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGgU1qc4CSX1m"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","top"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container><a href=http://beian.miit.gov.cn/ target=_blank>鲁ICP备2020034310号</a></br>©
2019 -
2023
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WF7TH97J9X"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-WF7TH97J9X",{anonymize_ip:!1})}</script></body></html>